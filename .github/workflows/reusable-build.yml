name: Reusable GDExtension Build

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
      arch:
        required: true
        type: string
      rust_target:
        required: true
        type: string
      precision:
        required: true
        type: string
      platform_id:
        required: true
        type: string
      macos_deployment_target:
        required: false
        type: string
        default: ""
      current_tag:
        required: false
        type: string
        default: ''
      compile_rust:
        required: false
        type: boolean
        default: false
      continue_on_error:
        required: false
        type: boolean
        default: false
      threads:
        required: false
        type: string
        default: 'yes'
      previous_tag:
        required: false
        type: string
        default: ''

jobs:
  build:
    name: Build ${{ inputs.platform_id }}-${{ inputs.arch }}-${{ inputs.precision }}
    runs-on: ${{ inputs.os }}
    continue-on-error: ${{ inputs.continue_on_error }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Download generated bindings
        if: inputs.compile_rust == false
        uses: actions/download-artifact@v4
        with:
          name: generated-bindings
          path: bindings/

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          PACKAGES="build-essential pkg-config dbus libdbus-1-dev protobuf-compiler libprotobuf-dev"
          if [ "${{ inputs.platform_id }}" = "windows-gnu" ]; then PACKAGES="$PACKAGES mingw-w64"; fi
          sudo apt-get install -y $PACKAGES
          python3 -m pip install scons protobuf

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf scons

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install python --version=3.11
          python -m pip install scons protobuf

      - name: Set up Emscripten
        if: inputs.platform_id == 'web'
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.62
          actions-cache-folder: 'emsdk-cache'

      - name: Set up Rust nightly
        if: inputs.compile_rust == true
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ inputs.rust_target }}

      - name: Cache uniffi-bindgen-cpp
        if: inputs.compile_rust == true
        id: cache-uniffi-bindgen-cpp
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/uniffi-bindgen-cpp
          key: ${{ runner.os }}-uniffi-bindgen-cpp-Larkooo-update-0.30
          restore-keys: |
            ${{ runner.os }}-uniffi-bindgen-cpp-Larkooo-update-0.30

      - name: Install uniffi-bindgen-cpp from source
        if: inputs.compile_rust == true && steps.cache-uniffi-bindgen-cpp.outputs.cache-hit != 'true'
        run: cargo install --git https://github.com/Larkooo/uniffi-bindgen-cpp --branch update-0.30 uniffi-bindgen-cpp

      - name: Install Android NDK
        if: inputs.platform_id == 'android'
        shell: bash
        run: |
          echo "y" | sudo ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager "ndk;23.2.8568313"
          echo "ANDROID_NDK_ROOT=${ANDROID_HOME}/ndk/23.2.8568313" >> $GITHUB_ENV

      - name: Download core artifacts (target)
        if: inputs.compile_rust == false
        uses: actions/download-artifact@v4
        with:
          name: core-build-${{ inputs.platform_id }}-${{ inputs.arch }}${{ inputs.platform_id != 'ios' && '-release' || '' }}
          path: godot-dojo-core/target

      - name: Debug - List downloaded artifacts
        shell: bash
        run: ls -R godot-dojo-core/target

      - name: Cache SCons and godot-cpp build artifacts
        uses: actions/cache@v4
        with:
          path: | # Note: These paths are relative to the checkout directory
            .sconsign.dblite
            build/
            external/godot-cpp/bin/
            external/godot-cpp/.sconsign.dblite
            external/godot-cpp/gen/
            external/godot-cpp/__pycache__/
          key: scons-cache-${{ inputs.platform_id }}-${{ inputs.arch }}-${{ inputs.precision }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            scons-cache-${{ inputs.platform_id }}-${{ inputs.arch }}-${{ inputs.precision }}-${{ github.ref_name }}-
            scons-cache-${{ inputs.platform_id }}-${{ inputs.arch }}-${{ inputs.precision }}-
            scons-cache-${{ inputs.platform_id }}-${{ inputs.arch }}-${{ inputs.precision }}-

      - name: Build GDExtension (editor)
        if: inputs.platform_id != 'ios'
        shell: bash
        run: |
          set -e
          export FORCE_RUST_RELEASE=1
          export SKIP_RUST_BUILD=${{ inputs.compile_rust == true && '0' || '1' }}
          export SKIP_BINDINGS_GENERATION=${{ inputs.compile_rust == true && '0' || '1' }}
          export CARGO_BUILD_TARGET=${{ inputs.rust_target }}
          if [ "${{ inputs.platform_id }}" = "android" ]; then
            unset ANDROID_HOME
          fi
          if [ "${{ runner.os }}" = "macOS" ] && [ -n "${{ inputs.macos_deployment_target }}" ]; then
            export MACOSX_DEPLOYMENT_TARGET=${{ inputs.macos_deployment_target }}
            export RUSTFLAGS="${RUSTFLAGS:+$RUSTFLAGS }-C link-arg=-mmacosx-version-min=${{ inputs.macos_deployment_target }}"
          fi
          mkdir -p demo/addons/godot-dojo
          SCONS_PLATFORM=${{ (inputs.platform_id == 'windows-gnu' || inputs.platform_id == 'windows-msvc') && 'windows' || inputs.platform_id }}
          scons platform=${SCONS_PLATFORM} arch=${{ inputs.arch }} target=editor precision=${{ inputs.precision }} threads=${{ inputs.threads }} -j2

      - name: Build GDExtension (template debug)
        if: inputs.platform_id != 'ios'
        shell: bash
        run: |
          set -e
          export FORCE_RUST_RELEASE=1
          export SKIP_RUST_BUILD=${{ inputs.compile_rust == true && '0' || '1' }}
          export SKIP_BINDINGS_GENERATION=${{ inputs.compile_rust == true && '0' || '1' }}
          export CARGO_BUILD_TARGET=${{ inputs.rust_target }}
          if [ "${{ inputs.platform_id }}" = "android" ]; then
            unset ANDROID_HOME
          fi
          if [ "${{ runner.os }}" = "macOS" ] && [ -n "${{ inputs.macos_deployment_target }}" ]; then
            export MACOSX_DEPLOYMENT_TARGET=${{ inputs.macos_deployment_target }}
            export RUSTFLAGS="${RUSTFLAGS:+$RUSTFLAGS }-C link-arg=-mmacosx-version-min=${{ inputs.macos_deployment_target }}"
          fi
          mkdir -p demo/addons/godot-dojo
          SCONS_PLATFORM=${{ (inputs.platform_id == 'windows-gnu' || inputs.platform_id == 'windows-msvc') && 'windows' || inputs.platform_id }}
          scons platform=${SCONS_PLATFORM} arch=${{ inputs.arch }} target=template_debug precision=${{ inputs.precision }} threads=${{ inputs.threads }} -j2

      - name: Build GDExtension (template release)
        if: inputs.platform_id != 'ios'
        shell: bash
        run: |
          set -e
          export FORCE_RUST_RELEASE=1
          export SKIP_RUST_BUILD=${{ inputs.compile_rust == true && '0' || '1' }}
          export SKIP_BINDINGS_GENERATION=${{ inputs.compile_rust == true && '0' || '1' }}
          export CARGO_BUILD_TARGET=${{ inputs.rust_target }}
          if [ "${{ inputs.platform_id }}" = "android" ]; then
            unset ANDROID_HOME
          fi
          if [ "${{ runner.os }}" = "macOS" ] && [ -n "${{ inputs.macos_deployment_target }}" ]; then
            export MACOSX_DEPLOYMENT_TARGET=${{ inputs.macos_deployment_target }}
            export RUSTFLAGS="${RUSTFLAGS:+$RUSTFLAGS }-C link-arg=-mmacosx-version-min=${{ inputs.macos_deployment_target }}"
          fi
          mkdir -p demo/addons/godot-dojo
          SCONS_PLATFORM=${{ (inputs.platform_id == 'windows-gnu' || inputs.platform_id == 'windows-msvc') && 'windows' || inputs.platform_id }}
          scons platform=${SCONS_PLATFORM} arch=${{ inputs.arch }} target=template_release precision=${{ inputs.precision }} threads=${{ inputs.threads }} -j2

      - name: Build for iOS Device (arm64)
        if: inputs.platform_id == 'ios'
        run: |
          export FORCE_RUST_RELEASE=1
          export SKIP_RUST_BUILD=1
          scons platform=ios arch=arm64 target=template_debug precision=${{ inputs.precision }} -j2
          export FORCE_RUST_RELEASE=1
          export SKIP_RUST_BUILD=1
          scons platform=ios arch=arm64 target=template_release precision=${{ inputs.precision }} -j2

      - name: Build for iOS Simulator (arm64)
        if: inputs.platform_id == 'ios'
        run: |
          export FORCE_RUST_RELEASE=1
          export SKIP_RUST_BUILD=1
          scons platform=ios arch=arm64 ios_simulator=yes target=template_debug precision=${{ inputs.precision }} -j2
          export FORCE_RUST_RELEASE=1
          export SKIP_RUST_BUILD=1
          scons platform=ios arch=arm64 ios_simulator=yes target=template_release precision=${{ inputs.precision }} -j2

      - name: Build for iOS Simulator (x86_64)
        if: inputs.platform_id == 'ios'
        run: |
          export FORCE_RUST_RELEASE=1
          export SKIP_RUST_BUILD=1
          scons platform=ios arch=x86_64 ios_simulator=yes target=template_debug precision=${{ inputs.precision }} -j2
          export FORCE_RUST_RELEASE=1
          export SKIP_RUST_BUILD=1
          scons platform=ios arch=x86_64 ios_simulator=yes target=template_release precision=${{ inputs.precision }} -j2

      - name: Assemble iOS XCFrameworks
        if: inputs.platform_id == 'ios'
        run: |
          export SKIP_RUST_BUILD=1
          scons platform=ios arch=universal assemble-ios target=template_debug precision=${{ inputs.precision }}
          export SKIP_RUST_BUILD=1
          scons platform=ios arch=universal assemble-ios target=template_release precision=${{ inputs.precision }}

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: bin-${{ inputs.precision }}-${{ inputs.platform_id }}-${{ inputs.arch }}-${{ inputs.threads }}
          path: |
            demo/addons/godot-dojo/bin
            demo/addons/godot-dojo/assets
            demo/addons/godot-dojo/godot-dojo.gdextension
          if-no-files-found: error
