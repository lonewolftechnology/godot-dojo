<!DOCTYPE html>
<html>
<head>
    <title>My Template</title>
    <meta charset="UTF-8">
</head>
<body>
<canvas id="canvas"></canvas>
<script src="$GODOT_URL"></script>
<script type="module">
    import init, * as dojo from './dojo_c_debug.js';

    function waitForGodot() {
        return new Promise(resolve => {
            (function check() {
                // Usamos `Engine` como nos indicaste, que es correcto para Godot 4.0.
                if (window.Engine) return resolve();
                setTimeout(check, 100); // Revisa cada 100ms
            })();
        });
    }

    async function main() {
        try {
            console.log("Initializing Dojo WASM module...");
            await init();
            console.log("Dojo WASM module initialized successfully.");

            window.dojoInstance = dojo;
            window.toriiClient = null; // Initialize torii client global
            console.log("Dojo instance: ", dojo);

            /**
             * Generic async bridge to call Dojo functions from Godot.
             * The last argument is expected to be the Godot callback.
             * All arguments before the last one are passed to the dojo function.
             * e.g., callDojoAsync(functionName, arg1, arg2, ..., godotCallback)
             */
            window.callDojoAsync = async function (functionName, ...args) {
                const isToriiCall = functionName.startsWith('toriiclient_');
                console.log(`[JS] Calling Dojo function: ${functionName}, Torii: ${isToriiCall}`);
                console.log(`[JS] Args:`, args);

                let funcName = functionName;
                let target;

                if (isToriiCall) {
                    if (functionName === 'toriiclient_new') {
                        // 'toriiclient_new' is special, it's on the main dojo instance.
                        target = window.dojoInstance;
                    } else {
                        // Other torii functions are on the torii client instance.
                        target = window.toriiClient;
                        funcName = functionName.substring(12); // "toriiclient_".length
                    }
                } else {
                    target = window.dojoInstance;
                }
                console.log(`[JS] Function: ${funcName}, Target:`, target);

                const godotCallback = args.pop(); // The real callback is always the last argument in the remaining list.

                // Process arguments to handle JSON-stringified objects
                const processedArgs = args.map(arg => {
                    if (typeof arg === 'string' && arg.startsWith('json:')) {
                        try {
                            // Parse the JSON string, removing the "json:" prefix.
                            let json = JSON.parse(arg.substring(5));
                            for (const [key, value] of Object.entries(json)) {
                                if (value === "<Object#null>") {
                                    console.log(`[JS] NULLING ${key}:`, value);
                                    json = undefined;
                                }
                            }
                            return json;
                        } catch (e) {
                            console.error("Failed to parse JSON argument:", arg, e);
                            // Return null if parsing fails, to prevent further errors.
                            return null;
                        }
                    }
                    return arg;
                });

                try {
                    let result;

                    // Special handling for creating a new ToriiClient instance.
                    if (functionName === 'toriiclient_new') {
                        console.log(`[WEB] Instantiating new ToriiClient with args:`, processedArgs);
                        // As per the new API, `dojoInstance` exposes a `ToriiClient` class.
                        // We instantiate it directly. The constructor is synchronous.
                        result = await new dojo.ToriiClient(...processedArgs);
                        window.toriiClient = result;
                    } else {
                        console.log(`[WEB] Calling Dojo function: ${funcName}`, "on target:", target, "with args:", processedArgs);

                        if (!target) {
                            throw new Error(`Target object for function "${funcName}" is not valid.`);
                        }
                        if (typeof target[funcName] !== 'function') {
                            throw new Error(`Dojo function "${funcName}" not found on target.`);
                        }

                        // For all other functions, call them on the appropriate target.
                        result = await target[funcName](...processedArgs);
                    }

                    if (godotCallback) {
                        const godotResult = result === undefined ? null : result;
                        console.log(`Calling Godot callback for "${funcName}" with result:`, godotResult);
                        try {
                            godotCallback(godotResult);
                        } finally {
                            // After calling the callback, release it from the C++ side to allow GC.
                            // We must use the instance_id for safe lookup.
                            if (godotCallback && typeof godotCallback.get_instance_id === 'function' && window.DojoBridge && typeof window.DojoBridge.release_callback === 'function') {
                                const callbackId = godotCallback.get_instance_id();
                                window.DojoBridge.release_callback(callbackId);
                            }
                        }
                    }
                } catch (err) {
                    console.error(`Error calling Dojo function "${funcName}":`, err);
                    // Call the callback with null on error to unblock the C++ side.
                    if (godotCallback) {
                        try {
                            godotCallback(null);
                        } finally {
                            if (godotCallback && typeof godotCallback.get_instance_id === 'function' && window.DojoBridge && typeof window.DojoBridge.release_callback === 'function') {
                                const callbackId = godotCallback.get_instance_id();
                                window.DojoBridge.release_callback(callbackId);
                            }
                        }
                    }
                }
            };

            console.log("Waiting for Godot engine to be ready...");
            await waitForGodot();
            console.log("Godot engine is ready. Starting game...");

            const engine = new Engine();
            engine.startGame($GODOT_CONFIG);
        } catch (err) {
            console.error("Error initializing application: ", err);
        }
    }

    main();
</script>
</body>
</html>